We apported several modification to the firmware, in order to program the Zolertia Z1 motes for our T\+S\+CH Airplane testbed.



 \hypertarget{_l_k_n_contribution_TSCH_scheduling}{}\section{T\+S\+C\+H scheduling}\label{_l_k_n_contribution_TSCH_scheduling}
We enabled a D\+AG root based scheduling by modifying the files \hyperlink{schedule_8c}{schedule.\+c} and \hyperlink{schedule_8h}{schedule.\+h} .

The setup applied in \hyperlink{schedule_8h}{schedule.\+h} by modifying the following frame parameters\+: 
\begin{DoxyCodeInclude}
\textcolor{preprocessor}{#define SLOTFRAME\_LENGTH    15}
\textcolor{preprocessor}{#define NUMSERIALRX          1 }
\textcolor{preprocessor}{#define NUMSLOTSOFF          1 }
\textcolor{preprocessor}{}
\textcolor{preprocessor}{#define SHARED FALSE}

\textcolor{comment}{//draft-ietf-6tisch-minimal-06 }
\textcolor{comment}{}\textcolor{preprocessor}{#define SCHEDULE\_MINIMAL\_6TISCH\_ACTIVE\_CELLS  SLOTFRAME\_LENGTH-NUMSERIALRX-NUMSLOTSOFF//default 1}
\textcolor{preprocessor}{#define SCHEDULE\_MINIMAL\_6TISCH\_SLOTOFFSET                        1//deafult time slot 0}
\textcolor{preprocessor}{#define SCHEDULE\_MINIMAL\_6TISCH\_CHANNELOFFSET                     0//default freq channel 0}
\textcolor{preprocessor}{#define SCHEDULE\_MINIMAL\_6TISCH\_DEFAULT\_SLOTFRAME\_HANDLE          1 //id of slotframe}
\textcolor{preprocessor}{#define SCHEDULE\_MINIMAL\_6TISCH\_DEFAULT\_SLOTFRAME\_NUMBER          1 //1 slotframe by default.}

\end{DoxyCodeInclude}
 The scheduling of the network is computed by the D\+AG root. In the function \hyperlink{group___schedule_gade694f312044f8bff151d58c7976d067}{schedule\+\_\+start\+D\+A\+Groot} the scheduling is applied iteratively in this way\+:


\begin{DoxyCodeInclude}
    addr\_cnt=1;
    \textcolor{keywordflow}{for} (running\_slotOffset=start\_slotOffset;running\_slotOffset<start\_slotOffset+
      \hyperlink{group___schedule_ga299d7e29eb70888b68ace83fd3f1a8df}{SCHEDULE\_MINIMAL\_6TISCH\_ACTIVE\_CELLS};running\_slotOffset++) \{
        temp\_neighbor.addr\_64b[7]   = addr\_cnt;
        addr\_cnt++;
      \hyperlink{group___schedule_ga00825b0f7040c67065d65aadde478241}{schedule\_addActiveSlot}(
         running\_slotOffset,                 \textcolor{comment}{// slot offset}
         \hyperlink{group___schedule_ggad8490d4fdf8cef27f7e5fa6a37046a3da703f29e4d2b16980f09eceaeb7a35281}{CELLTYPE\_TXRX},                      \textcolor{comment}{// type of slot}
         \hyperlink{group___schedule_ga884c794595c4aa480df9022648c29564}{SHARED},                               \textcolor{comment}{// shared?}
         \hyperlink{group___schedule_ga485a603a3e03059901c4fc5fc968a1e9}{SCHEDULE\_MINIMAL\_6TISCH\_CHANNELOFFSET},    \textcolor{comment}{// channel offset
       (default SCHEDULE\_MINIMAL\_6TISCH\_CHANNELOFFSET) TODO try different offsets}
         &temp\_neighbor                      \textcolor{comment}{// neighbor}
      );
      \hyperlink{group___schedule_gafbaaa0f57ce9c382c0fc00225a7b2078}{debugPrint\_schedule}();
   \}
\end{DoxyCodeInclude}
 

 \hypertarget{_l_k_n_contribution_IE_processing}{}\section{I\+E processing}\label{_l_k_n_contribution_IE_processing}
In order to spread the D\+AG root scheduling over the whole network, we enabled the trasmission of link-\/specific address information and link settings.

In particular, we modified the functions \hyperlink{process_i_e_8h_a222b2d57ad09b945b098f211cd159e53}{process\+I\+E\+\_\+prepend\+Slotframe\+Link\+IE}, \hyperlink{process_i_e_8h_a41d90fd25e8ce294b9d7632d43089c80}{process\+I\+E\+\_\+retrieve\+Slotframe\+Link\+IE} in \hyperlink{process_i_e_8c}{process\+I\+E.\+c} such that is possible to associate the address of a specific mote to the IE link scheduling parameter. Furthermore, the value of the S\+H\+A\+R\+ED flag is also transmitted and retrieved.

In \hyperlink{process_i_e_8h_a222b2d57ad09b945b098f211cd159e53}{process\+I\+E\+\_\+prepend\+Slotframe\+Link\+IE}, we enabled the transmission of the address and the link option parameters in this way\+: 
\begin{DoxyCodeInclude}
   
   \textcolor{comment}{// For each link in the default schedule, add:}
   \textcolor{comment}{// - [1B] linkOption bitmap}
   \textcolor{comment}{// - [2B] channel offset}
   \textcolor{comment}{// - [2B] timeslot}
   \textcolor{comment}{// - [3B] Neighbour value -NEW}
 
   \textcolor{comment}{//===== shared cells}
   linkOption = (1<<\hyperlink{group___i_e_e_e802154_e_ggaa8d5243a5473317d5e534e093d0842d2ad2ad324754167c22e203d395ab806743}{FLAG\_TX\_S})|(1<<\hyperlink{group___i_e_e_e802154_e_ggaa8d5243a5473317d5e534e093d0842d2a5c0f22602ca83af1733a5e18a7e6f20f}{FLAG\_RX\_S})|(1<<
      \hyperlink{group___i_e_e_e802154_e_ggaa8d5243a5473317d5e534e093d0842d2a60b8f45b435950f10cb9d755e09fa295}{FLAG\_SHARED\_S})|(1<<\hyperlink{group___i_e_e_e802154_e_ggaa8d5243a5473317d5e534e093d0842d2aeea4c693b0c82c42470264523a1c2656}{FLAG\_TIMEKEEPING\_S});
   \hyperlink{pmc_8c_acb559820d9ca11295b4500f179ef6392}{i}=1;
   \textcolor{keywordflow}{for} (slotOffset=lastSlotOffset;slotOffset>\hyperlink{group___schedule_ga62c64cb1c9bbbb2927f358c14535fb7f}{SCHEDULE\_MINIMAL\_6TISCH\_SLOTOFFSET}
      ;slotOffset--) \{
      \hyperlink{group___packet_functions_ga690ad87588077409f382584732259925}{packetfunctions\_reserveHeaderSize}(pkt,6);
      pkt->payload[0]   = (slotOffset-1)        & 0xFF;             \textcolor{comment}{// slotOffset}
      pkt->payload[1]   = ((slotOffset-1) >> 8) & 0xFF;             \textcolor{comment}{//}
      pkt->payload[2]   = \hyperlink{group___schedule_ga485a603a3e03059901c4fc5fc968a1e9}{SCHEDULE\_MINIMAL\_6TISCH\_CHANNELOFFSET};    \textcolor{comment}{//
       channel offset}
      pkt->payload[3]   = 0x00;
      pkt->payload[4]   = linkOption;                               \textcolor{comment}{// linkOption bitmap}
      pkt->payload[5]   = slotOffset-1;                             \textcolor{comment}{// Address value}
      \hyperlink{pmc_8c_acb559820d9ca11295b4500f179ef6392}{i}++;
      len+=6;
   \}
\end{DoxyCodeInclude}
 In \hyperlink{process_i_e_8h_a41d90fd25e8ce294b9d7632d43089c80}{process\+I\+E\+\_\+retrieve\+Slotframe\+Link\+IE}, the opposite mechanism is implemented and properly enables the receiver to store the information into the next active slot\+: 
\begin{DoxyCodeInclude}
            \textcolor{comment}{// [1B] LinkOption bitmap}
            linkInfo.linkoptions = *((\hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}*)(pkt->payload)+localptr);
            my\_shared=(linkInfo.linkoptions & ( 1 << 6 )) >> 6; \textcolor{comment}{//Retrieve the 6-th bit (SHARED)}
            localptr++;
            
            \textcolor{comment}{// [3B] Neighbour value - LKN}
            neighAddr = *((\hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}*)(pkt->payload)+localptr);
            localptr++;

            temp\_neighbor.type         = \hyperlink{opendefs_8h_a52864abcf6ebd8d120995b36fe6ce06eaaca0da977da87a831efebdda8b376fa1}{ADDR\_64B};
            temp\_neighbor.addr\_64b[0]   = 0x14;
            temp\_neighbor.addr\_64b[1]   = 0x15;
            temp\_neighbor.addr\_64b[2]   = 0x92;
            temp\_neighbor.addr\_64b[3]   = 0xcc;
            temp\_neighbor.addr\_64b[4]   = 0x00;
            temp\_neighbor.addr\_64b[5]   = 0x00;
            temp\_neighbor.addr\_64b[6]   = 0x00;
            temp\_neighbor.addr\_64b[7]   = neighAddr;
            
            \textcolor{comment}{// shared TXRX anycast slot(s)}
            \hyperlink{group___schedule_ga00825b0f7040c67065d65aadde478241}{schedule\_addActiveSlot}(
               linkInfo.tsNum,                     \textcolor{comment}{// slot offset}
               \hyperlink{group___schedule_ggad8490d4fdf8cef27f7e5fa6a37046a3da703f29e4d2b16980f09eceaeb7a35281}{CELLTYPE\_TXRX},                      \textcolor{comment}{// type of slot}
               my\_shared,                          \textcolor{comment}{// default false, not implemented}
               linkInfo.choffset,                  \textcolor{comment}{// channel offset}
               &temp\_neighbor                      \textcolor{comment}{// neighbor}
            );
\end{DoxyCodeInclude}
 

 \hypertarget{_l_k_n_contribution_MAC_behavior}{}\section{M\+A\+C behavior}\label{_l_k_n_contribution_MAC_behavior}
The scope of our project is to enable proper link scheduling in T\+S\+CH. To this end, we modified the minimal version of the 802.\+15.\+4e M\+AC layer in order to support our scheduling mechanism.

All the parameters concerning the M\+AC layer can be set in \hyperlink{_i_e_e_e802154_e_8h}{I\+E\+E\+E802154\+E.\+h}. The channel hopping temnplate that we used is the following\+:


\begin{DoxyCodeInclude}
\textcolor{keyword}{static} \textcolor{keyword}{const} \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} chTemplate\_default[] = \{
   5,9,12,7,15,4,14,11,8,0,1,2,13,3,6,10
\};
\end{DoxyCodeInclude}
 Additionally, these are the M\+AC layer parameters that we used in our project\+:


\begin{DoxyCodeInclude}
\textcolor{preprocessor}{#define LKN\_RECORD\_RSSI               1 //enable recording rssi into the packet payload}
\textcolor{preprocessor}{#define HOPPING                      1 // Boolean value for enabling freq. hopping}
\textcolor{preprocessor}{#define SYNCHRONIZING\_CHANNEL       20 // channel the mote listens on to synchronize}
\textcolor{preprocessor}{#define TXRETRIES                    2 // number of MAC retries before declaring failed}
\textcolor{preprocessor}{#define TX\_POWER                     19 // 1=-25dBm, 31=0dBm (max value)}
\textcolor{preprocessor}{#define RESYNCHRONIZATIONGUARD       5 // in 32kHz ticks. min distance to the end of the slot to
       successfully synchronize}
\textcolor{preprocessor}{#define US\_PER\_TICK                 30 // number of us per 32kHz clock tick}
\textcolor{preprocessor}{#define EBPERIOD                    10 // in seconds: sending EB every 30 seconds}
\textcolor{preprocessor}{#define MAXKAPERIOD               2000 // in slots: @15ms per slot -> ~30 seconds. Max value used by
       adaptive synchronization.}
\textcolor{preprocessor}{#define DESYNCTIMEOUT             2333 // in slots: @15ms per slot -> ~35 seconds. A larger DESYNCTIMEOUT
       is needed if using a larger KATIMEOUT.}
\textcolor{preprocessor}{#define LIMITLARGETIMECORRECTION     5 // threshold number of ticks to declare a timeCorrection "large"}
\textcolor{preprocessor}{#define LENGTH\_IEEE154\_MAX         128 // max length of a valid radio packet}
\textcolor{preprocessor}{#define DUTY\_CYCLE\_WINDOW\_LIMIT    (0xFFFFFFFF>>1) // limit of the dutycycle window}
\end{DoxyCodeInclude}


In order to enable address-\/specific scheduling parameters, we need to apport several major modifications in the file \hyperlink{_i_e_e_e802154_e_8c}{I\+E\+E\+E802154\+E.\+c}. The 802.\+15.\+4E code structure is summerized here\+: \href{https://www.mindmeister.com/656557809/ieee802154e-code-structure}{\tt I\+E\+E\+E802154E code structure} by \href{https://www.mindmeister.com/users/channel/12733408}{\tt Samuele Zoppi}

First, we modified the main function of the M\+AC scheme, it determines the behavior during the current Time Slot, i.\+e., it enables the reception and/or transmission of packets.

We modified the function such that the mote can transmit or receive only if it is its own Time Slot. At the beginning, we set the value can\+TX to F\+A\+L\+SE, then we turn it to T\+R\+UE by testing its address with respect of the current time slot.
\begin{DoxyItemize}
\item D\+AG root is always allowed to receive and transmit.
\item Motes are not allowed either to RX or TX in a Time Slot that doesn\textquotesingle{}t match their address.
\end{DoxyItemize}


\begin{DoxyCodeInclude}
          \textcolor{comment}{//Here checks the address}
          \hyperlink{group___schedule_ga6a1d0334cd9da212a38a1db05e291d3a}{schedule\_getNeighbor}(&cell\_neighbor);
          \textcolor{keywordflow}{if}(!\hyperlink{group___i_d_manager_ga4cff67772250923086a3d6476eb673c8}{idmanager\_isMyAddress}(&cell\_neighbor))\{
                \textcolor{keywordflow}{if}(\hyperlink{group___i_d_manager_gaa792e6561333f1615bbc61392e826d39}{idmanager\_getIsDAGroot}()==\hyperlink{types_8h_aa93f0eb578d23995850d61f7d61c55c1}{FALSE})\{
                    \textcolor{comment}{// this is NOT MY active slot, end the slot}
                    \hyperlink{group___open_serial_ga3459b731e462b664947a4e3260c51512}{openserial\_stop}();
                    \hyperlink{_i_e_e_e802154_e_8c_a4d32f5f6b6be4f7b407550ae26a898df}{endSlot}();
                    \textcolor{comment}{//start outputing serial}
                    \hyperlink{group___open_serial_gaf25875805325e15644a0cc1ddf2d1ad7}{openserial\_startOutput}();
                    \textcolor{keywordflow}{return};
                \}\textcolor{keywordflow}{else}\{
                    \textcolor{comment}{//I am DAG root but I don't need to TX}
                \}
          \}\textcolor{keywordflow}{else}\{
                \textcolor{comment}{//It is my address}
                canTX=\hyperlink{types_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE};
          \}

         \textcolor{keywordflow}{if}(canTX)\{
             \textcolor{comment}{// stop using serial}
             \hyperlink{group___open_serial_ga3459b731e462b664947a4e3260c51512}{openserial\_stop}();
             \textcolor{comment}{// assuming that there is nothing to send}
             \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_a88449ac7a09ec14e0053fdcf6a6ac790}{dataToSend} = \hyperlink{arm__cm4_8h_a070d2ce7b6bb7e5c05602aa8c308d0c4}{NULL};
             \textcolor{comment}{// check whether we can send}
             \textcolor{keywordflow}{if} (\hyperlink{group___schedule_gab5a0194710b51bf73b6aa363cb2fd8cb}{schedule\_getOkToSend}()) \{
                memset(&neighbor,0,\textcolor{keyword}{sizeof}(neighbor));
                neighbor.type             = \hyperlink{opendefs_8h_a52864abcf6ebd8d120995b36fe6ce06eac81661e9fd1e185f968667664896d0b9}{ADDR\_ANYCAST};\textcolor{comment}{//Allows to send a packet to ANYONE}
                \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_a88449ac7a09ec14e0053fdcf6a6ac790}{dataToSend} = 
      \hyperlink{group___open_queue_ga654ff57cc43c12704d87dc66fcfe7fa2}{openqueue\_macGetDataPacket}(&neighbor);
\end{DoxyCodeInclude}
 Furthermore, we modified the behavior of the function \hyperlink{_i_e_e_e802154_e_8c_a01c55569f4f1aadf1d4a156b08014e50}{calculate\+Frequency} sucht that the calculation of the next frequency hop is enabled by the variable \hyperlink{group___i_e_e_e802154_e_ga495914ac755e3089a99e6a6946c12971}{H\+O\+P\+P\+I\+NG}. Otherwise, the next frequency is always set to the common \hyperlink{group___i_e_e_e802154_e_gaf8be83417584fa06ecb6982f183bd222}{S\+Y\+N\+C\+H\+R\+O\+N\+I\+Z\+I\+N\+G\+\_\+\+C\+H\+A\+N\+N\+EL}.


\begin{DoxyCodeInclude}
    \textcolor{keywordflow}{if}(\hyperlink{group___i_e_e_e802154_e_ga495914ac755e3089a99e6a6946c12971}{HOPPING})\{
        \textcolor{keywordflow}{return} 11 + \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_a8ea426fa464ed96aeb12f16c2985171d}{chTemplate}[(
      \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_acd689febb1e54412f6faff6a6db0b5c9}{asnOffset}+channelOffset)%16]; \textcolor{comment}{//channel hopping}
    \}\textcolor{keywordflow}{else}\{
        \textcolor{keywordflow}{return} \hyperlink{group___i_e_e_e802154_e_gaf8be83417584fa06ecb6982f183bd222}{SYNCHRONIZING\_CHANNEL};
    \}
\end{DoxyCodeInclude}


Another major modification involves the management of the current Slot Offset. Previously, its cycle was based on a predefined value of the Frame Length, our contribution enables Slot Offset incraments and synchronization over arbitrary Frame Length lengths.

Here, we modify the function \hyperlink{_i_e_e_e802154_e_8c_af7ddc5c9b10da0b029a6cdf13d40455d}{increment\+Asn\+Offset} to allow arbitrary values of Frame Length. 
\begin{DoxyCodeInclude}
   \textcolor{comment}{// increment the offsets}
   frameLength = \hyperlink{group___schedule_gad9d1ef9965017c2923cb6905b7cc6b7f}{schedule\_getFrameLength}();
   \textcolor{keywordflow}{if} (frameLength == 0) \{
      \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_afaebb453ec589e83866278ddf8d1cb9d}{slotOffset}++;
   \} \textcolor{keywordflow}{else} \{
      \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_afaebb453ec589e83866278ddf8d1cb9d}{slotOffset}  = (\hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.
      \hyperlink{structieee154e__vars__t_afaebb453ec589e83866278ddf8d1cb9d}{slotOffset}+1)%frameLength;
   \}
\end{DoxyCodeInclude}
 Then, the function \hyperlink{_i_e_e_e802154_e_8c_aee836d385fb2379dd04956ad7b3cfe37}{ieee154e\+\_\+sync\+Slot\+Offset} was implemented. It allows the synchronization of the Slot Offset based on the current value of A\+SN. 
\begin{DoxyCodeInclude}
\hyperlink{samr21__xpro_2board__info_8h_ac176b886c94b2cf591ec32600fb61a07}{port\_INLINE} \textcolor{keywordtype}{void} \hyperlink{_i_e_e_e802154_e_8c_aee836d385fb2379dd04956ad7b3cfe37}{ieee154e\_syncSlotOffset}() \{
   \hyperlink{group___schedule_gab960413860c0b01b38ece025b0ee534d}{frameLength\_t} frameLength;
   \hyperlink{_p_e___types_8h_a33594304e786b158f3fb30289278f5af}{uint32\_t} slotOffset;

   frameLength = \hyperlink{group___schedule_gad9d1ef9965017c2923cb6905b7cc6b7f}{schedule\_getFrameLength}();

   \textcolor{comment}{// determine the current slotOffset}
   slotOffset = \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_ad43118eadedc6a7dabf63f316bdda819}{asn}.\hyperlink{structasn__t_af158e9c9bc092ed0347896a9c024c258}{byte4};
   slotOffset = slotOffset % frameLength;
   slotOffset = slotOffset << 16;
   slotOffset = slotOffset + \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_ad43118eadedc6a7dabf63f316bdda819}{asn}.\hyperlink{structasn__t_ae7a99f086ee6e28c6c72e248b6041b95}{bytes2and3};
   slotOffset = slotOffset % frameLength;
   slotOffset = slotOffset << 16;
   slotOffset = slotOffset + \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_ad43118eadedc6a7dabf63f316bdda819}{asn}.\hyperlink{structasn__t_a9d2a032fe9b1adf08fc25d1cc73e8745}{bytes0and1};
   slotOffset = slotOffset % frameLength;

   \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_afaebb453ec589e83866278ddf8d1cb9d}{slotOffset}       = (\hyperlink{group___schedule_ga30a663860a70d8c9db2c3a8e66f544fc}{slotOffset\_t}) slotOffset;
\}
\end{DoxyCodeInclude}
 The methods are then used in \hyperlink{_i_e_e_e802154_e_8c_aa42be4c16fe53e0460a63ae76438d668}{ieee154e\+\_\+process\+I\+Es} to properly adapt the Slot Offset upon arrival of a new A\+SN value. 
\begin{DoxyCodeInclude}
         \textcolor{keywordflow}{if} (f\_asn2slotoffset == \hyperlink{types_8h_aa8cecfc5c5c054d2875c03e77b7be15d}{TRUE}) \{
            \textcolor{comment}{// at this point, ASN and frame length are known}
            \textcolor{comment}{// the current slotoffset can be inferred}
            \hyperlink{_i_e_e_e802154_e_8c_aee836d385fb2379dd04956ad7b3cfe37}{ieee154e\_syncSlotOffset}();
            \hyperlink{group___schedule_gaf44e496db5d623ea8168d0eaeffc8b2d}{schedule\_syncSlotOffset}(\hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.
      \hyperlink{structieee154e__vars__t_afaebb453ec589e83866278ddf8d1cb9d}{slotOffset});
            \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_a4c8775df9573fdd1e6a4cfe501d95d60}{nextActiveSlotOffset} = 
      \hyperlink{group___schedule_ga01252633416fb574b1277b1303030248}{schedule\_getNextActiveSlotOffset}();

            \hyperlink{_i_e_e_e802154_e_8c_a8decad47b1e2b92bfc8a910f19d30ab3}{ieee154e\_syncAsnOffset}();
         \}
\end{DoxyCodeInclude}


Finally, we stored the contents of different parameters under interest in the payload of our application. This allows us to collect packet-\/related information and analyze them in a second place.

Here, we store the value of the frequency used for transmission\+: 
\begin{DoxyCodeInclude}
   \textcolor{comment}{//Set the tx frequency in the packet}
   \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_a88449ac7a09ec14e0053fdcf6a6ac790}{dataToSend}->\hyperlink{struct_open_queue_entry__t_a1c9c4a2da1e43eb8d9fd2b310f9f524e}{l4\_payload}[3] = 
      \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_a98c1bb462ffdc5720382fc437a7893a3}{freq};
   
   \textcolor{comment}{// configure the radio for that frequency}
    \textcolor{keywordflow}{if}(!\hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_ace57dfc664b0948d066507ff4f7a77ff}{my\_couldSendEB})\{
        \hyperlink{group__radio_gaa062a57421da7b960a2613e4f65d3a11}{radio\_setFrequency}(\hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_a98c1bb462ffdc5720382fc437a7893a3}{freq});
    \}\textcolor{keywordflow}{else}\{
        \hyperlink{group__radio_gaa062a57421da7b960a2613e4f65d3a11}{radio\_setFrequency}(\hyperlink{group___i_e_e_e802154_e_gaf8be83417584fa06ecb6982f183bd222}{SYNCHRONIZING\_CHANNEL});
    \}
\end{DoxyCodeInclude}
 Here, we store the value of the retransmission counter, once it is updated\+: 
\begin{DoxyCodeInclude}
\end{DoxyCodeInclude}
 Here, we store the value of the received packet\textquotesingle{}s R\+S\+SI\+: 
\begin{DoxyCodeInclude}
      \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_afeb8cae851f042cb066c4b482fe519b3}{dataReceived}->\hyperlink{struct_open_queue_entry__t_aeeaf66f25c665e41a219c4097e5085da}{payload}[
      \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_afeb8cae851f042cb066c4b482fe519b3}{dataReceived}->\hyperlink{struct_open_queue_entry__t_aa3cf5004f2ac9ef3a888f42e726a5cce}{length}-3] = 0xff - 
      \hyperlink{_i_e_e_e802154_e_8c_abbfc7f36c7b2d2635f4407908445a89b}{ieee154e\_vars}.\hyperlink{structieee154e__vars__t_afeb8cae851f042cb066c4b482fe519b3}{dataReceived}->\hyperlink{struct_open_queue_entry__t_ae28cb0e81313085c3227cebe8ccecf33}{l1\_rssi} + 1;
\end{DoxyCodeInclude}
 

 \hypertarget{_l_k_n_contribution_Uinject_application}{}\section{Uinject custom application}\label{_l_k_n_contribution_Uinject_application}
In order to properly test the behavior of the network, we developed a simple application that sends uplink traffic periodically. Additionally, we designed the application to allocate payload bytes in order to track additional information about the packets that are sent.

First, we modified the \hyperlink{openapps_8c}{openapps.\+c} and \hyperlink{openstack_8c}{openstack.\+c} in order to allow the initialization of the \hyperlink{group__uinject_gac6dcaebf6fba84d30d183c304c65040e}{uinject\+\_\+init}.

Then, we defined in \hyperlink{uinject_8h}{uinject.\+h} the periodicity \hyperlink{group__uinject_ga5b31a0d33a0be3a28d77fbdba9a3e2b7}{U\+I\+N\+J\+E\+C\+T\+\_\+\+P\+E\+R\+I\+O\+D\+\_\+\+MS}, a data structure that contains a timer variable and a counter used to add numeration to the packets that are generated.


\begin{DoxyCodeInclude}
\textcolor{preprocessor}{#define UINJECT\_PERIOD\_MS 700}

\textcolor{comment}{//=========================== typedef =========================================}

\textcolor{keyword}{typedef} \textcolor{keyword}{struct }\{
   \hyperlink{group___open_timers_gae5ca9e65d270cdfa4bc74008d96d69ab}{opentimer\_id\_t}       timerId;  
   \hyperlink{_p_e___types_8h_a1f1825b69244eb3ad2c7165ddc99c956}{uint16\_t}             \hyperlink{boards_2eldorado_2radio_8c_a0480b812cba9c1d9c71a5fb1071bd0fc}{counter};  
\} \hyperlink{structuinject__vars__t}{uinject\_vars\_t};

\end{DoxyCodeInclude}
 Furthermore, we set the destination address of our application to the D\+AG root address.


\begin{DoxyCodeInclude}
\textcolor{keyword}{static} \textcolor{keyword}{const} \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} uinject\_dst\_addr[]   = \{
   0xbb, 0xbb, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01
\};
\end{DoxyCodeInclude}
 Finally, here we report the code containg the details of the application that is exevuted in \hyperlink{uinject_8c_a59951fd503ef80b9526ba1eaaf952d9b}{uinject\+\_\+task\+\_\+cb}. Once the header of the packet is set, we increment the packet counter, and we reserve space for 5 bytes of additional information that will be stored later during the M\+AC layer operations.


\begin{DoxyCodeInclude}
   \hyperlink{uinject_8c_a24b960a84347986d2bc83683d2793bf0}{uinject\_vars}.\hyperlink{structuinject__vars__t_a97940d6759ea18706492ae05ad24730f}{counter}++;
   
   \hyperlink{group___packet_functions_ga690ad87588077409f382584732259925}{packetfunctions\_reserveHeaderSize}(pkt,5*\textcolor{keyword}{sizeof}(
      \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}));
   *((\hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}*)&pkt->payload[0]) = \hyperlink{group___i_e_e_e802154_e_ga2ad5d0a4cdd37feb8c5e52db2978062f}{TXRETRIES}+1;
   *((\hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}*)&pkt->payload[1]) = \hyperlink{uinject_8c_a24b960a84347986d2bc83683d2793bf0}{uinject\_vars}.\hyperlink{structuinject__vars__t_a97940d6759ea18706492ae05ad24730f}{counter}>>8;
   *((\hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}*)&pkt->payload[2]) = \hyperlink{uinject_8c_a24b960a84347986d2bc83683d2793bf0}{uinject\_vars}.\hyperlink{structuinject__vars__t_a97940d6759ea18706492ae05ad24730f}{counter};
   *((\hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}*)&pkt->payload[3]) = 0; \textcolor{comment}{//reserverd for frequency}
   *((\hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t}*)&pkt->payload[4]) = 0; \textcolor{comment}{//reserved for RSSI}

   \textcolor{keywordflow}{if} ((\hyperlink{group___open_udp_ga9e3ddc36106b92231cf7cfb3b5cabbd4}{openudp\_send}(pkt))==\hyperlink{opendefs_8h_a85c7862086c1f92e4fb4108e176d8140afd5484f4c22c4ddd79b539facd9ad7eb}{E\_FAIL}) \{
      \hyperlink{group___open_queue_ga326f90b6a0c7a331257b524a5af236d4}{openqueue\_freePacketBuffer}(pkt);
   \}
\end{DoxyCodeInclude}
 

 \hypertarget{_l_k_n_contribution_Serial_compression}{}\section{Serial compression}\label{_l_k_n_contribution_Serial_compression}
\char`\"{}\+Compress\char`\"{} the packets on serial interface in order to enable forwarding the packets to the openvisualizer faster. The \char`\"{}compression\char`\"{} only forwards part of the pkt id and its payload to the openvisualizer. Serial drivers are modified\+: \hyperlink{openserial_8c}{openserial.\+c} and \hyperlink{openserial_8h}{openserial.\+h}


\begin{DoxyCodeInclude}

  \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} isCompressed = 0;
   \textcolor{keywordflow}{if} (\hyperlink{group___open_serial_ga6499f570e793bb2111f482628e521a1b}{ENABLE\_PKT\_COMPRESSION})\{
    \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} isCompressed = 1;
    \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(isCompressed);

    \textcolor{comment}{//danger! durty solution! to be changed if the packet structure changes}

    \textcolor{comment}{//extract necessary data from buffer}
    \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} srcId = buffer[15];
    \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} retx = buffer[\hyperlink{namespacecc2538-bsl_a805cc7085603640390bef3787085a8aa}{length}-5];
    \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} seqN1 = buffer[\hyperlink{namespacecc2538-bsl_a805cc7085603640390bef3787085a8aa}{length}-4];
    \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} seqN2 = buffer[\hyperlink{namespacecc2538-bsl_a805cc7085603640390bef3787085a8aa}{length}-3];
    \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} freq = buffer[\hyperlink{namespacecc2538-bsl_a805cc7085603640390bef3787085a8aa}{length}-2];
    \hyperlink{_p_e___types_8h_aba7bc1797add20fe3efdf37ced1182c5}{uint8\_t} rssi = buffer[\hyperlink{namespacecc2538-bsl_a805cc7085603640390bef3787085a8aa}{length}-1];
    \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(srcId);
    \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(retx);
    \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(seqN1);
    \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(seqN2);
    \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(freq);
    \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(rssi);

   \}
   \textcolor{keywordflow}{else} \{
      \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(isCompressed);
     \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(asn[0]);
     \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(asn[1]);
     \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(asn[2]);
     \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(asn[3]);
     \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(asn[4]);
     \textcolor{keywordflow}{for} (\hyperlink{pmc_8c_acb559820d9ca11295b4500f179ef6392}{i}=0;\hyperlink{pmc_8c_acb559820d9ca11295b4500f179ef6392}{i}<\hyperlink{namespacecc2538-bsl_a805cc7085603640390bef3787085a8aa}{length};\hyperlink{pmc_8c_acb559820d9ca11295b4500f179ef6392}{i}++)\{
        \hyperlink{openserial_8c_ac2be7cae6115dbefd4e59aa401b52598}{outputHdlcWrite}(buffer[\hyperlink{pmc_8c_acb559820d9ca11295b4500f179ef6392}{i}]);
     \}
   \}

\end{DoxyCodeInclude}
 
\begin{DoxyCodeInclude}
\textcolor{preprocessor}{#define ENABLE\_PKT\_COMPRESSION 0}
\end{DoxyCodeInclude}
 

 \hypertarget{_l_k_n_contribution_Minor_changes}{}\section{Minor changes}\label{_l_k_n_contribution_Minor_changes}
\hypertarget{_l_k_n_contribution_Addr_edits}{}\subsection{Mote addressing}\label{_l_k_n_contribution_Addr_edits}
In the function \hyperlink{group___i_d_manager_ga3e974443ae75269d00c3de03992a1669}{idmanager\+\_\+init} we modify the address of the motes.

The address of the device is set in this way\+: 
\begin{DoxyCodeInclude}
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a2abdbb15dedda5606521852a4b4fc0ba}{type}         = \hyperlink{opendefs_8h_a52864abcf6ebd8d120995b36fe6ce06eaaca0da977da87a831efebdda8b376fa1}{ADDR\_64B};
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a7ca9b0c966447d191c6f05e375571231}{addr\_64b}[0]   = 0x14;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a7ca9b0c966447d191c6f05e375571231}{addr\_64b}[1]   = 0x15;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a7ca9b0c966447d191c6f05e375571231}{addr\_64b}[2]   = 0x92;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a7ca9b0c966447d191c6f05e375571231}{addr\_64b}[3]   = 0xcc;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a7ca9b0c966447d191c6f05e375571231}{addr\_64b}[4]   = 0x00;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a7ca9b0c966447d191c6f05e375571231}{addr\_64b}[5]   = 0x00;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a7ca9b0c966447d191c6f05e375571231}{addr\_64b}[6]   = 0x00;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_a41c964b52056d4022c136419ab5d0704}{my64bID}.\hyperlink{structopen__addr__t_a7ca9b0c966447d191c6f05e375571231}{addr\_64b}[7]   = 1;
\end{DoxyCodeInclude}
 If the device is D\+A\+G-\/root, then the prefix of the device is set in the following way\+: 
\begin{DoxyCodeInclude}
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_ad563fc083ecc8c561374241382e76c89}{myPrefix}.\hyperlink{structopen__addr__t_a026c06dfd492ddbde8e4d4254fd35ce3}{prefix}[0]   = 0xbb;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_ad563fc083ecc8c561374241382e76c89}{myPrefix}.\hyperlink{structopen__addr__t_a026c06dfd492ddbde8e4d4254fd35ce3}{prefix}[1]   = 0xbb;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_ad563fc083ecc8c561374241382e76c89}{myPrefix}.\hyperlink{structopen__addr__t_a026c06dfd492ddbde8e4d4254fd35ce3}{prefix}[2]   = 0x00;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_ad563fc083ecc8c561374241382e76c89}{myPrefix}.\hyperlink{structopen__addr__t_a026c06dfd492ddbde8e4d4254fd35ce3}{prefix}[3]   = 0x00;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_ad563fc083ecc8c561374241382e76c89}{myPrefix}.\hyperlink{structopen__addr__t_a026c06dfd492ddbde8e4d4254fd35ce3}{prefix}[4]   = 0x00;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_ad563fc083ecc8c561374241382e76c89}{myPrefix}.\hyperlink{structopen__addr__t_a026c06dfd492ddbde8e4d4254fd35ce3}{prefix}[5]   = 0x00;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_ad563fc083ecc8c561374241382e76c89}{myPrefix}.\hyperlink{structopen__addr__t_a026c06dfd492ddbde8e4d4254fd35ce3}{prefix}[6]   = 0x00;
   \hyperlink{idmanager_8c_a3b050a996ba4875e4327fb81fbb18c5b}{idmanager\_vars}.\hyperlink{structidmanager__vars__t_ad563fc083ecc8c561374241382e76c89}{myPrefix}.\hyperlink{structopen__addr__t_a026c06dfd492ddbde8e4d4254fd35ce3}{prefix}[7]   = 0x00;
\end{DoxyCodeInclude}
 \hypertarget{_l_k_n_contribution_Radio_edits}{}\subsection{Changes in the Radio driver}\label{_l_k_n_contribution_Radio_edits}
The radio was hardcoded set to 0. In our code we set the P\+A\+\_\+\+L\+E\+V\+EL in \hyperlink{group__radio_gaf181029cf06b94f0f4ceaafec1c3f209}{radio\+\_\+reset} to 31. 
\begin{DoxyCodeInclude}
   cc2420\_TXCTRL\_reg.PA\_LEVEL               = 31; \textcolor{comment}{//31 max. TX power (~0dBm)}
\end{DoxyCodeInclude}
 \hypertarget{_l_k_n_contribution_Neighbor_edits}{}\subsection{Changes in the Neighbor table}\label{_l_k_n_contribution_Neighbor_edits}
In our code we set the \hyperlink{group___neighbors_gaf83606573bb704d34705b540c226a0d9}{M\+A\+X\+N\+U\+M\+N\+E\+I\+G\+H\+B\+O\+RS} to 12 to enable a larger network. 
\begin{DoxyCodeInclude}
\textcolor{preprocessor}{#define MAXNUMNEIGHBORS           12}
\end{DoxyCodeInclude}
 \hypertarget{_l_k_n_contribution_DAG_root}{}\subsection{D\+A\+G root setup}\label{_l_k_n_contribution_DAG_root}
We modified the define in \hyperlink{opendefs_8h}{opendefs.\+h} in order to enable the D\+AG root state from the firmware. 
\begin{DoxyCodeInclude}
\textcolor{preprocessor}{#define DAGROOT 1}
\end{DoxyCodeInclude}
